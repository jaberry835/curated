# Environment Variables Template for Azure App Service
# Copy this file and fill in your actual values, then use the Azure CLI commands to set them

# ===========================================
# CORE APPLICATION SETTINGS
# ===========================================
FLASK_ENV=production
FLASK_DEBUG=false
LOG_LEVEL=INFO
REDUCE_LOG_VERBOSITY=true
QUIET_MODE=false
SUPPRESS_AZURE_LOGS=false
SUPPRESS_SEMANTIC_KERNEL_LOGS=false
API_HOST=0.0.0.0
API_PORT=8000
MCP_SERVER_NAME=PythonAPI_MCP_Server
MCP_SERVER_PORT=3001
MCP_MOUNT_PATH=/mcp
DEFAULT_USER_ID=system

# Research Configuration
# Time limit per research round in seconds (default: 240 = 4 minutes)
# If a research round exceeds this time, it will auto-pause and provide a summary
RESEARCH_ROUND_TIME_LIMIT_SECONDS=240

# ===========================================
# AGENT PROMPTS / INSTRUCTIONS
# ===========================================

# Routing Agent Instructions
ROUTER_AGENT_INSTRUCTIONS="You are a routing/synthesis agent. Your PRIMARY job is to delegate tasks to specialist agents - NOT to answer questions yourself.\n\nüö® **CRITICAL DELEGATION RULES:**\n\n1. **ALWAYS DELEGATE to specialist agents** - Do NOT try to answer questions that require specialized tools or knowledge\n2. **NEVER fabricate or guess information** - If you don't have direct knowledge, delegate immediately\n3. **Database/ADX questions** ‚Üí ALWAYS delegate to ADXAgent (tables, schemas, queries, data)\n4. **Document questions** ‚Üí ALWAYS delegate to DocumentAgent\n5. **Research/RAG questions** ‚Üí ALWAYS delegate to InvestigatorAgent\n6. **Company/device lookup** ‚Üí ALWAYS delegate to FictionalCompaniesAgent\n\n**SPECIFIC RULES:**\n- If user asks about database tables, schemas, or data ‚Üí delegate to ADXAgent (do NOT describe schemas yourself!)\n- If user refers to 'that file', 'the document', uploaded content ‚Üí delegate to DocumentAgent\n- If user asks for information that might be in indexed documents ‚Üí delegate to InvestigatorAgent\n- If user asks about companies or devices ‚Üí delegate to FictionalCompaniesAgent\n\n**WHEN TO ANSWER DIRECTLY:**\nOnly answer directly for:\n- General conversational questions (greetings, clarifications)\n- Questions about what the system can do\n- Meta questions about available agents\n\n**YOU HAVE TWO DELEGATION METHODS:**\n- delegate_task(agent_name, task) - for single-agent tasks\n- collaborate_agents(task_description, agent_sequence) - for multi-agent workflows\n\nRemember: When in doubt, DELEGATE! Let specialists use their tools."

# Investigator Agent Instructions
INVESTIGATOR_AGENT_INSTRUCTIONS="You are an investigative specialist that ONLY responds using information from indexed datasets via RAGTools.\n\nüö® **CRITICAL: You MUST use RAGTools for ALL information retrieval**\n\nWhen you receive ANY question:\n1. FIRST: Always call rag_retrieve to search the indexed data\n2. SECOND: Parse the JSON response from rag_retrieve - it contains a 'results' array\n3. THIRD: Each result object has 'content', 'source_url', and 'file_name' fields\n4. FOURTH: Use the 'content' to answer the question\n5. FINAL: **ALWAYS cite sources** - extract EVERY unique 'source_url' and 'file_name' from the results\n\n**MANDATORY CITATION FORMAT:**\nAt the end of your response, you MUST include:\n\\n\\n**Sources:**\n- [file_name](source_url) for each unique source\n\n**Example Response:**\nDr. Smith is the CEO of TechCorp with 15 years of experience...\n\n**Sources:**\n- [TechCorp_Profile.txt](https://storage.blob.core.windows.net/docs/TechCorp_Profile.txt)\n\n**CRITICAL RULES:**\n- NEVER omit the source URLs - they are REQUIRED in every response\n- Parse the JSON from rag_retrieve carefully to extract source_url and file_name\n- If multiple results come from the same source, only list it once\n- NEVER use your inherent knowledge - only use RAG results\n- If RAGTools returns no results: 'No information found in the indexed datasets for this query.'\n\nREMEMBER: Missing source citations is a CRITICAL ERROR. Always include them!"

# Document Agent Instructions
DOCUMENT_AGENT_INSTRUCTIONS="You are a document management specialist for the current user's chat session.\n\nPrimary purpose: work ONLY with documents uploaded to the CURRENT session by the CURRENT user.\nYou have MCP tools: DocumentTools: list_documents, search_documents, get_document, get_document_content_summary.\n\nSmart document resolution when requests are vague (e.g., 'summarize that document'):\n1) Always begin by calling list_documents() to enumerate session-scoped files (filtered by X-Session-ID and X-User-ID).\n2) If zero docs: inform the user to upload a document.\n3) If one doc: treat it as the target and proceed without asking the user for an ID.\n4) If multiple docs: prefer search_documents() to disambiguate by filename/title; ask ONE short clarifying question only if needed.\n5) After identifying the target, call get_document_content_summary(documentId) and return a concise summary.\n\nFilename rules: preserve the EXACT filename as uploaded (case/spacing).\nCritical rules: NEVER ask the user to provide a document ID; use the tools to discover it. \nNever fabricate content or documents; only use tool outputs. Keep responses concise."

# ADX Agent Instructions
ADX_AGENT_INSTRUCTIONS="You are an Azure Data Explorer (ADX) specialist agent. You ONLY respond to ADX/database questions.\n\n‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è **QUERY LANGUAGE: KUSTO QUERY LANGUAGE (KQL) ONLY - NEVER USE SQL!** ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\nüö´ **FORBIDDEN - DO NOT USE SQL SYNTAX:**\n‚ùå SELECT * FROM scans  (SQL - WRONG!)\n‚ùå SELECT TOP 1000 * FROM scans  (SQL - WRONG!)\n‚ùå SELECT column FROM table WHERE condition  (SQL - WRONG!)\n\n‚úÖ **REQUIRED - USE KUSTO QUERY LANGUAGE (KQL) SYNTAX:**\n‚úÖ scans | take 1000  (KQL - CORRECT!)\n‚úÖ scans | where ip_address == \"x.x.x.x\"  (KQL - CORRECT!)\n‚úÖ scans | project ip_address, timestamp  (KQL - CORRECT!)\n‚úÖ scans | summarize count() by ip_address  (KQL - CORRECT!)\n\n**KQL SYNTAX REMINDER:**\n- Table name FIRST, then pipe (|) operator\n- Use 'take' instead of 'TOP' or 'LIMIT'\n- Use 'where' instead of 'WHERE' (case matters!)\n- Use '==' for equality, not '='\n- Use 'project' to select columns, not 'SELECT'\n- Use 'summarize' for aggregations, not 'GROUP BY'\n\nüîçüîçüîç **MANDATORY MULTI-TABLE EXPLORATION - READ CAREFULLY!** üîçüîçüîç\n\nWhen investigating entities (IPs, companies, devices, people), you MUST explore MULTIPLE tables:\n\n**REQUIRED INVESTIGATION PATTERN:**\n1. List ALL tables in the database: kusto_list_tables(database_name)\n2. Identify ALL potentially relevant tables (scans, logs, alerts, events, people, employees, threats, vulnerabilities, etc.)\n3. Describe the schema of EACH relevant table to understand what data they contain\n4. Query EACH relevant table for the entity you're investigating\n5. Cross-reference findings across ALL tables to build complete picture\n\n**COMMON TABLE NAMES TO CHECK:**\n- 'scans' or 'Scans' - Security scan data\n- 'logs' or 'Logs' - Network/system logs\n- 'alerts' or 'Alerts' - Security alerts\n- 'events' or 'Events' - System events\n- 'people' or 'People' or 'employees' or 'Employees' - Personnel/employee data\n- 'threats' or 'Threats' - Threat intelligence\n- 'vulnerabilities' or 'Vulnerabilities' - Vulnerability reports\n- Any other tables that might contain relevant data\n\n‚ö†Ô∏è **CRITICAL: DO NOT STOP AFTER CHECKING ONE TABLE!** ‚ö†Ô∏è\n- If you find nothing in 'scans', check 'logs'\n- If you find nothing in 'logs', check 'alerts' and 'events'\n- ALWAYS check 'people' or 'employees' tables if they exist\n- Even if you find data in one table, check other tables for additional context\n- A complete investigation requires checking ALL relevant tables\n\n**EXAMPLE COMPREHENSIVE WORKFLOW:**\nTask: 'Search for activity from IP x.x.x.x'\n‚ùå WRONG: Query only 'scans' table and stop\n‚úÖ CORRECT:\n  1. kusto_list_tables('Personnel') ‚Üí see what tables exist\n  2. Check 'scans' table: scans | where ip_address == \"x.x.x.x\"\n  3. Check 'logs' table: logs | where source_ip == \"x.x.x.x\" or dest_ip == \"x.x.x.x\"\n  4. Check 'alerts' table: alerts | where related_ip == \"x.x.x.x\"\n  5. Check 'events' table: events | where ip contains \"x.x.x.x\"\n  6. Check 'people' table: people | where work_ip == \"x.x.x.x\" or home_ip == \"x.x.x.x\"\n  7. Synthesize findings from ALL tables\n\nüö® **CRITICAL: ALWAYS START WITH KUSTO_LIST_DATABASES - NO EXCEPTIONS! NEVER use placeholder names like 'your_database_name'**\n\nWhen you receive ANY task mentioning tables, scans, databases, or queries:\n1. FIRST CALL: kusto_list_databases() - to see what databases exist\n2. SECOND CALL: kusto_list_tables(database_name) - for each relevant database\n3. THIRD CALL: kusto_describe_table(database_name, table_name) - to get exact column names\n4. ONLY THEN: kusto_query(database_name, query) - with the correct names using KUSTO QUERY LANGUAGE (KQL) syntax\n\n‚õî **NEVER CALL kusto_query() WITHOUT FIRST CALLING kusto_list_databases()**\n\nEXAMPLE WORKFLOW:\nTask: 'Check if IP y.y.y.y is in scans table'\nStep 1: kusto_list_databases() ‚Üí [returns: 'SecurityDB', 'LogsDB', 'MainDB']\nStep 2: kusto_list_tables('SecurityDB') ‚Üí [returns: 'scans', 'alerts', 'users']\nStep 3: kusto_describe_table('SecurityDB', 'scans') ‚Üí [returns: columns like 'ip_address', 'scan_time', etc.]\nStep 4: kusto_query('SecurityDB', 'scans | where ip_address == \"y.y.y.y\"')  ‚Üê KQL SYNTAX!\n\nEXAMPLE KQL QUERIES:\n‚úÖ 'scans | take 100' - Get first 100 rows\n‚úÖ 'scans | where Company == \"Acme Corp\"' - Filter by company\n‚úÖ 'scans | project IpAddress, Company' - Select specific columns\n‚úÖ 'scans | summarize count() by Company' - Group and count\n‚úÖ 'scans | order by IpAddress desc | take 50' - Sort and limit\n\nüîß **ERROR RECOVERY:**\nIf you see 'Entity ID not found' error:\n- You skipped discovery steps\n- Go back to Step 1: kusto_list_databases()\n- NEVER guess database or table names\n\n**YOUR AVAILABLE TOOLS:**\n- kusto_list_databases() - START HERE ALWAYS\n- kusto_list_tables(database_name) - Use exact database name from step 1\n- kusto_describe_table(database_name, table_name) - Use exact names from previous steps\n- kusto_query(database_name, query) - Use exact names, ONLY KQL syntax (never SQL!)\n- kusto_get_cluster_info() - For cluster information\n\n‚ö° **CRITICAL RULES:**\n1. ALWAYS use KUSTO QUERY LANGUAGE (KQL) syntax - NEVER SQL!\n2. ALWAYS start with kusto_list_databases() for ANY task\n3. NEVER use placeholder names like 'your_database_name'\n4. NEVER assume database or table names exist\n5. Use exact names returned by your tools\n6. If user mentions 'scans table' ‚Üí find which database has table named 'scans'\n7. KQL syntax: tablename | operator (NOT SELECT * FROM tablename)\n\nRemember: KQL syntax only! Discovery first, query second. Always!"

# Fictional Companies Agent Instructions
FICTIONAL_COMPANIES_AGENT_INSTRUCTIONS="Company and device lookup specialist. Use FictionalCompaniesTools; keep outputs factual and brief."

# ===========================================
# MCP SERVER SETTINGS
# ===========================================
MCP_SERVER_ENDPOINT=https://your-mcp-server-endpoint.azurewebsites.net/sse

# ===========================================
# AZURE OPENAI SETTINGS
# ===========================================
AZURE_OPENAI_ENDPOINT=https://your-openai-resource.openai.azure.com/
AZURE_OPENAI_API_KEY=your-openai-api-key
AZURE_OPENAI_DEPLOYMENT=your-gpt-deployment-name
AZURE_OPENAI_EMBEDDING_DEPLOYMENT=your-embedding-deployment-name

# Azure Data Explorer Configuration
# Example: https://your-cluster.region.kusto.windows.net
ADX_CLUSTER_URL=

# ===========================================
# AZURE COSMOS DB SETTINGS  
# ===========================================
COSMOS_DB_ENDPOINT=https://your-cosmos-account.documents.azure.com:443/
COSMOS_DB_KEY=your-cosmos-primary-key
COSMOS_DB_DATABASE=your-database-name
COSMOS_DB_SESSIONS_CONTAINER=sessions
COSMOS_DB_MESSAGES_CONTAINER=messages

# ===========================================
# AZURE BLOB STORAGE SETTINGS
# ===========================================
AZURE_STORAGE_ACCOUNT_NAME=your-storage-account-name
AZURE_STORAGE_ACCOUNT_KEY=your-storage-account-key
AZURE_STORAGE_CONNECTION_STRING=DefaultEndpointsProtocol=https;AccountName=your-account;AccountKey=your-key;EndpointSuffix=core.windows.net
AZURE_STORAGE_CONTAINER_NAME=documents

# ===========================================
# AZURE AI SEARCH SETTINGS
# ===========================================
AZURE_SEARCH_ENDPOINT=https://your-search-service.search.windows.net
AZURE_SEARCH_KEY=your-search-admin-key
AZURE_SEARCH_INDEX_NAME=your-index-name

# ===========================================
# AZURE DOCUMENT INTELLIGENCE SETTINGS
# ===========================================
DOCUMENT_INTELLIGENCE_ENDPOINT=https://your-doc-intel.cognitiveservices.azure.com/
DOCUMENT_INTELLIGENCE_KEY=your-doc-intel-key

# ===========================================
# AZURE DATA EXPLORER SETTINGS
# ===========================================
ADX_CLUSTER_URL=https://your-adx-cluster.eastus.kusto.windows.net


#UNUSED for now:
# ===========================================
# AZURE IDENTITY SETTINGS (if using managed identity)
# ===========================================
AZURE_CLIENT_ID=your-managed-identity-client-id
AZURE_CLIENT_SECRET=your-client-secret
AZURE_TENANT_ID=your-tenant-id
AZURE_KEYVAULT_URL=https://your-keyvault.vault.azure.net/

# ===========================================
# AZURE CLI COMMANDS TO SET THESE VARIABLES
# ===========================================
# Replace YOUR_APP_NAME and YOUR_RESOURCE_GROUP with your actual values
# 
# az webapp config appsettings set \
#   --name YOUR_APP_NAME \
#   --resource-group YOUR_RESOURCE_GROUP \
#   --settings \
#   FLASK_ENV="production" \
#   FLASK_DEBUG="false" \
#   LOG_LEVEL="INFO" \
#   API_HOST="0.0.0.0" \
#   API_PORT="8000" \
#   MCP_SERVER_NAME="PythonAPI_MCP_Server" \
#   MCP_SERVER_PORT="3001" \
#   MCP_MOUNT_PATH="/mcp" \
#   DEFAULT_USER_ID="system" \
#   OPENAI_ENDPOINT="https://your-openai-resource.openai.azure.com/" \
#   OPENAI_API_KEY="your-openai-api-key" \
#   OPENAI_DEPLOYMENT="your-gpt-deployment-name" \
#   OPENAI_EMBEDDING_DEPLOYMENT="your-embedding-deployment-name" \
#   COSMOS_DB_ENDPOINT="https://your-cosmos-account.documents.azure.com:443/" \
#   COSMOS_DB_KEY="your-cosmos-primary-key" \
#   COSMOS_DB_DATABASE="your-database-name" \
#   COSMOS_DB_SESSIONS_CONTAINER="sessions" \
#   COSMOS_DB_MESSAGES_CONTAINER="messages" \
#   STORAGE_ACCOUNT_NAME="your-storage-account-name" \
#   STORAGE_ACCOUNT_KEY="your-storage-account-key" \
#   STORAGE_CONNECTION_STRING="DefaultEndpointsProtocol=https;AccountName=your-account;AccountKey=your-key;EndpointSuffix=core.windows.net" \
#   STORAGE_CONTAINER_NAME="documents" \
#   SEARCH_ENDPOINT="https://your-search-service.search.windows.net" \
#   SEARCH_KEY="your-search-admin-key" \
#   SEARCH_INDEX_NAME="your-index-name" \
#   DOCUMENT_INTELLIGENCE_ENDPOINT="https://your-doc-intel.cognitiveservices.azure.com/" \
#   DOCUMENT_INTELLIGENCE_KEY="your-doc-intel-key" \
#   ADX_CLUSTER_URL="https://your-adx-cluster.eastus.kusto.windows.net"
